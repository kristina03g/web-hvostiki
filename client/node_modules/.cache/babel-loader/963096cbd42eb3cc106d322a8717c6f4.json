{"ast":null,"code":"import { geometry as geom, drawing as draw } from '@progress/kendo-drawing';\nimport { Class, addClass, setDefaultOptions, deepExtend, defaultErrorHandler } from '../common';\nimport { Box } from '../core';\nimport { encodeData } from './encodings/encoding';\nimport { extend } from './utils';\nimport { surfaceSize } from '../barcode/surface-size';\nvar round = Math.round;\nvar crossPattern = [[0, 1], [1, 1], [1, 2], [2, 2], [2, 1], [3, 1], [3, 0], [2, 0], [2, -1], [1, -1], [1, 0]];\nvar squarePattern = [[0, 1], [1, 1], [1, 0]];\nvar QRCodeDefaults = {\n  DEFAULT_SIZE: 200,\n  QUIET_ZONE_LENGTH: 4,\n  DEFAULT_ERROR_CORRECTION_LEVEL: \"L\",\n  DEFAULT_BACKGROUND: \"#fff\",\n  DEFAULT_DARK_MODULE_COLOR: \"#000\",\n  MIN_BASE_UNIT_SIZE: 1,\n  DEFAULT_LOGO_SIZE: 7\n};\nvar QRCode = function (Class) {\n  function QRCode(element, options, errorHandler) {\n    if (errorHandler === void 0) errorHandler = defaultErrorHandler;\n    Class.call(this);\n    this.options = deepExtend({}, this.options, options);\n    this.element = element;\n    this.wrapper = this.element;\n    this.onError = errorHandler;\n    this._initElement();\n    this._initSurface();\n    this.setOptions(options);\n  }\n  if (Class) QRCode.__proto__ = Class;\n  QRCode.prototype = Object.create(Class && Class.prototype);\n  QRCode.prototype.constructor = QRCode;\n  QRCode.prototype.destroy = function destroy() {\n    this._destroySurface();\n  };\n  QRCode.prototype._initElement = function _initElement() {\n    addClass(this.element, \"k-qrcode\");\n  };\n  QRCode.prototype._initSurface = function _initSurface() {\n    var ref = this;\n    var options = ref.options;\n    var surface = ref.surface;\n    if (!surface || surface.options.type !== options.renderAs) {\n      this._destroySurface();\n      this._initSurfaceElement();\n      this.surface = this._createSurface();\n    }\n  };\n  QRCode.prototype._createSurface = function _createSurface() {\n    return draw.Surface.create(this.surfaceElement, {\n      type: this.options.renderAs\n    });\n  };\n  QRCode.prototype._destroySurface = function _destroySurface() {\n    if (this.surface) {\n      this.surface.destroy();\n      this.surface = null;\n      this._destroySurfaceElement();\n    }\n  };\n  QRCode.prototype._initSurfaceElement = function _initSurfaceElement() {\n    if (!this.surfaceElement) {\n      this.surfaceElement = document.createElement('div');\n      this.surfaceElement.style.position = \"relative\";\n      this.element.appendChild(this.surfaceElement);\n    }\n  };\n  QRCode.prototype._destroySurfaceElement = function _destroySurfaceElement() {\n    if (this.surfaceElement && this.surfaceElement.parentNode) {\n      this.surfaceElement.parentNode.removeChild(this.surfaceElement);\n      this.surfaceElement = null;\n    }\n  };\n  QRCode.prototype.redraw = function redraw() {\n    var size = this._getSize();\n    this.surface.clear();\n    this.surface.setSize({\n      width: size,\n      height: size\n    });\n    this.createVisual();\n    this.surface.draw(this.visual);\n  };\n  QRCode.prototype.getSize = function getSize() {\n    var element = this.element;\n    var elementWidth = element.clientWidth;\n    var elementHeight = element.clientHeight;\n    var size = {\n      width: 0,\n      height: 0\n    };\n    if (elementWidth > 0) {\n      size.width = elementWidth;\n    }\n    if (elementHeight) {\n      size.height = elementHeight;\n    }\n    return size;\n  };\n  QRCode.prototype._resize = function _resize() {\n    this.redraw();\n  };\n  QRCode.prototype.createVisual = function createVisual() {\n    this.visual = this._render();\n  };\n  QRCode.prototype.exportVisual = function exportVisual() {\n    return this._render();\n  };\n  QRCode.prototype._render = function _render() {\n    var value = this._value,\n      baseUnit,\n      border = this.options.border || {},\n      padding = this.options.padding || 0,\n      borderWidth = border.width || 0,\n      quietZoneSize,\n      matrix,\n      size,\n      dataSize,\n      contentSize;\n    border.width = borderWidth;\n    var visual = new draw.Group();\n    try {\n      if (value) {\n        matrix = encodeData(value, this.options.errorCorrection, this.options.encoding);\n        size = this._getSize();\n        contentSize = size - 2 * (borderWidth + padding);\n        baseUnit = this._calculateBaseUnit(contentSize, matrix.length);\n        dataSize = matrix.length * baseUnit;\n        quietZoneSize = borderWidth + padding + (contentSize - dataSize) / 2;\n        visual.append(this._renderBackground(size, border));\n        visual.append(this._renderMatrix(matrix, baseUnit, quietZoneSize));\n        if (this._hasCustomLogo()) {\n          visual.append(this._renderLogo(size, baseUnit));\n        } else if (this._isSwiss()) {\n          visual.append(this._renderSwissCode(size, baseUnit));\n        }\n      }\n    } catch (error) {\n      this.onError(error);\n    }\n    return visual;\n  };\n  QRCode.prototype._renderLogo = function _renderLogo(qrSize, baseUnit) {\n    var image;\n    var imageRect;\n    var center = round(qrSize / 2);\n    var logoSize = this._getLogoSize(baseUnit * QRCodeDefaults.DEFAULT_LOGO_SIZE);\n    var logoUrl = this.options.overlay.imageUrl;\n    var position = {\n      x: center - logoSize.width / 2,\n      y: center - logoSize.height / 2\n    };\n    imageRect = new geom.Rect(new geom.Point(position.x, position.y), new geom.Size(logoSize.width, logoSize.height));\n    image = new draw.Image(logoUrl, imageRect);\n    return image;\n  };\n  QRCode.prototype._renderSwissCode = function _renderSwissCode(qrSize, baseUnit) {\n    var logoSize = this._getLogoSize(baseUnit * QRCodeDefaults.DEFAULT_LOGO_SIZE);\n    logoSize = Math.max(logoSize.width, logoSize.height);\n    var crossSize = logoSize / 4;\n    var crossOffset = crossSize / 2;\n    var center = qrSize / 2;\n    var start = {};\n    var visual = new draw.Group();\n    start.x = start.y = Math.ceil(center - baseUnit - logoSize / 2);\n    visual.append(this._renderShape(start, Math.ceil(logoSize + baseUnit * 2), squarePattern, \"#fff\"));\n    start.x = start.y = center - logoSize / 2;\n    visual.append(this._renderShape(start, logoSize, squarePattern, this.options.color));\n    start.x = center + crossOffset - logoSize / 2;\n    start.y = center + crossOffset + crossSize - logoSize / 2;\n    visual.append(this._renderShape(start, crossSize, crossPattern, \"#fff\"));\n    return visual;\n  };\n  QRCode.prototype._renderShape = function _renderShape(start, step, pattern, color) {\n    var path = new draw.MultiPath({\n      fill: {\n        color: color\n      },\n      stroke: null\n    });\n    path.moveTo(start.x, start.y);\n    for (var i = 0; i < pattern.length; i++) {\n      path.lineTo(start.x + step * pattern[i][0], start.y + step * pattern[i][1]);\n    }\n    path.close();\n    return path;\n  };\n  QRCode.prototype._getSize = function _getSize() {\n    var size;\n    if (this.options.size) {\n      size = parseInt(this.options.size, 10);\n    } else {\n      var element = this.element;\n      var elementSize = surfaceSize(element, this.options.renderAs);\n      var min = Math.min(elementSize.width, elementSize.height);\n      if (min > 0) {\n        size = min;\n      } else {\n        size = QRCodeDefaults.DEFAULT_SIZE;\n      }\n    }\n    return size;\n  };\n  QRCode.prototype._calculateBaseUnit = function _calculateBaseUnit(size, matrixSize) {\n    var baseUnit = Math.floor(size / matrixSize);\n    if (baseUnit < QRCodeDefaults.MIN_BASE_UNIT_SIZE) {\n      var minSize = Math.ceil(matrixSize * QRCodeDefaults.MIN_BASE_UNIT_SIZE);\n      this.onError(new Error(\"Insufficient size for QR Code: the current size is \" + size + \"px and the minimum size is \" + minSize + \"px.\"));\n    } else if (baseUnit * matrixSize >= size && baseUnit - 1 >= QRCodeDefaults.MIN_BASE_UNIT_SIZE) {\n      baseUnit--;\n    }\n    return baseUnit;\n  };\n  QRCode.prototype._renderMatrix = function _renderMatrix(matrix, baseUnit, quietZoneSize) {\n    var path = new draw.MultiPath({\n      fill: {\n        color: this.options.color\n      },\n      stroke: null\n    });\n    for (var row = 0; row < matrix.length; row++) {\n      var y = quietZoneSize + row * baseUnit;\n      var column = 0;\n      while (column < matrix.length) {\n        while (matrix[row][column] === 0 && column < matrix.length) {\n          column++;\n        }\n        if (column < matrix.length) {\n          var x = column;\n          while (matrix[row][column] === 1) {\n            column++;\n          }\n          var x1 = round(quietZoneSize + x * baseUnit);\n          var y1 = round(y);\n          var x2 = round(quietZoneSize + column * baseUnit);\n          var y2 = round(y + baseUnit);\n          path.moveTo(x1, y1).lineTo(x1, y2).lineTo(x2, y2).lineTo(x2, y1).close();\n        }\n      }\n    }\n    return path;\n  };\n  QRCode.prototype._renderBackground = function _renderBackground(size, border) {\n    var box = new Box(0, 0, size, size).unpad(border.width / 2);\n    var background = draw.Path.fromRect(box.toRect(), {\n      fill: {\n        color: this.options.background\n      },\n      stroke: {\n        color: border.color,\n        width: border.width\n      }\n    });\n    return background;\n  };\n  QRCode.prototype.setOptions = function setOptions(options) {\n    var newOptions = options || {};\n    this.options = extend(this.options, newOptions);\n    if (options.value !== undefined) {\n      this._value = String(this.options.value);\n    }\n    this._initSurface();\n    this.redraw();\n  };\n  QRCode.prototype.value = function value(value$1) {\n    if (value$1 === undefined) {\n      return this._value;\n    }\n    this._value = String(value$1);\n    this.redraw();\n  };\n  QRCode.prototype._hasCustomLogo = function _hasCustomLogo() {\n    return Boolean(this.options.overlay.imageUrl);\n  };\n  QRCode.prototype._isSwiss = function _isSwiss() {\n    return this.options.overlay.type === \"swiss\";\n  };\n  QRCode.prototype._getLogoSize = function _getLogoSize(defautLogoSize) {\n    var width = this.options.overlay.width;\n    var height = this.options.overlay.height;\n    if (!width && !height) {\n      width = height = defautLogoSize;\n    } else if (width && !height) {\n      height = width;\n    } else if (!width && height) {\n      width = height;\n    }\n    return {\n      width: width,\n      height: height\n    };\n  };\n  return QRCode;\n}(Class);\nsetDefaultOptions(QRCode, {\n  name: \"QRCode\",\n  renderAs: \"svg\",\n  encoding: \"ISO_8859_1\",\n  value: \"\",\n  errorCorrection: QRCodeDefaults.DEFAULT_ERROR_CORRECTION_LEVEL,\n  background: QRCodeDefaults.DEFAULT_BACKGROUND,\n  color: QRCodeDefaults.DEFAULT_DARK_MODULE_COLOR,\n  size: \"\",\n  padding: 0,\n  border: {\n    color: \"\",\n    width: 0\n  },\n  overlay: {\n    type: \"image\",\n    imageUrl: \"\",\n    width: 0,\n    height: 0\n  }\n});\nexport default QRCode;","map":null,"metadata":{},"sourceType":"module"}