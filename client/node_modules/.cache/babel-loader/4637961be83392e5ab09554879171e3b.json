{"ast":null,"code":"import BaseSurface from '../core/surface';\nimport { createPromise, promiseAll, bindEvents, elementSize, unbindEvents } from '../util';\nimport RootNode from './root-node';\nimport ShapesQuadTree from '../search/shapes-quad-tree';\nimport SurfaceCursor from './surface-cursor';\nimport ArcNode from './arc-node';\nimport CircleNode from './circle-node';\nimport GroupNode from './group-node';\nimport ImageNode from './image-node';\nimport MultiPathNode from './multi-path-node';\nimport PathNode from './path-node';\nimport RectNode from './rect-node';\nimport TextNode from './text-node';\nimport NODE_MAP from './node-map';\nNODE_MAP.Arc = ArcNode;\nNODE_MAP.Circle = CircleNode;\nNODE_MAP.Group = GroupNode;\nNODE_MAP.Image = ImageNode;\nNODE_MAP.MultiPath = MultiPathNode;\nNODE_MAP.Path = PathNode;\nNODE_MAP.Rect = RectNode;\nNODE_MAP.Text = TextNode;\nvar Surface = function (BaseSurface) {\n  function Surface(element, options) {\n    BaseSurface.call(this, element, options);\n    this.element.innerHTML = this._template(this);\n    var canvas = this.element.firstElementChild;\n    canvas.style.width = '100%';\n    canvas.style.height = '100%';\n    var size = elementSize(element);\n    canvas.width = size.width;\n    canvas.height = size.height;\n    this._rootElement = canvas;\n    this._root = new RootNode(canvas, size);\n    this._mouseTrackHandler = this._trackMouse.bind(this);\n    bindEvents(this.element, {\n      click: this._mouseTrackHandler,\n      mousemove: this._mouseTrackHandler\n    });\n  }\n  if (BaseSurface) Surface.__proto__ = BaseSurface;\n  Surface.prototype = Object.create(BaseSurface && BaseSurface.prototype);\n  Surface.prototype.constructor = Surface;\n  var prototypeAccessors = {\n    type: {\n      configurable: true\n    }\n  };\n  prototypeAccessors.type.get = function () {\n    return \"canvas\";\n  };\n  Surface.prototype.destroy = function destroy() {\n    BaseSurface.prototype.destroy.call(this);\n    if (this._root) {\n      this._root.destroy();\n      this._root = null;\n    }\n    if (this._searchTree) {\n      this._searchTree.clear();\n      delete this._searchTree;\n    }\n    if (this._cursor) {\n      this._cursor.destroy();\n      delete this._cursor;\n    }\n    unbindEvents(this.element, {\n      click: this._mouseTrackHandler,\n      mousemove: this._mouseTrackHandler\n    });\n  };\n  Surface.prototype.draw = function draw(element) {\n    BaseSurface.prototype.draw.call(this, element);\n    this._root.load([element], undefined, this.options.cors);\n    if (this._searchTree) {\n      this._searchTree.add([element]);\n    }\n  };\n  Surface.prototype.clear = function clear() {\n    BaseSurface.prototype.clear.call(this);\n    this._root.clear();\n    if (this._searchTree) {\n      this._searchTree.clear();\n    }\n    if (this._cursor) {\n      this._cursor.clear();\n    }\n  };\n  Surface.prototype.eventTarget = function eventTarget(e) {\n    if (this._searchTree) {\n      var point = this._surfacePoint(e);\n      var shape = this._searchTree.pointShape(point);\n      return shape;\n    }\n  };\n  Surface.prototype.image = function image() {\n    var ref = this;\n    var root = ref._root;\n    var rootElement = ref._rootElement;\n    var loadingStates = [];\n    root.traverse(function (childNode) {\n      if (childNode.loading) {\n        loadingStates.push(childNode.loading);\n      }\n    });\n    var promise = createPromise();\n    var resolveDataURL = function resolveDataURL() {\n      root._invalidate({\n        fixedScale: true\n      });\n      try {\n        var data = rootElement.toDataURL();\n        promise.resolve(data);\n      } catch (e) {\n        promise.reject(e);\n      }\n    };\n    promiseAll(loadingStates).then(resolveDataURL, resolveDataURL);\n    return promise;\n  };\n  Surface.prototype.suspendTracking = function suspendTracking() {\n    BaseSurface.prototype.suspendTracking.call(this);\n    if (this._searchTree) {\n      this._searchTree.clear();\n      delete this._searchTree;\n    }\n  };\n  Surface.prototype.resumeTracking = function resumeTracking() {\n    BaseSurface.prototype.resumeTracking.call(this);\n    if (!this._searchTree) {\n      this._searchTree = new ShapesQuadTree();\n      var childNodes = this._root.childNodes;\n      var rootElements = [];\n      for (var idx = 0; idx < childNodes.length; idx++) {\n        rootElements.push(childNodes[idx].srcElement);\n      }\n      this._searchTree.add(rootElements);\n    }\n  };\n  Surface.prototype._resize = function _resize() {\n    this._rootElement.width = this._size.width;\n    this._rootElement.height = this._size.height;\n    this._root.size = this._size;\n    this._root.invalidate();\n  };\n  Surface.prototype._template = function _template() {\n    return \"<canvas></canvas>\";\n  };\n  Surface.prototype._enableTracking = function _enableTracking() {\n    this._searchTree = new ShapesQuadTree();\n    this._cursor = new SurfaceCursor(this);\n    BaseSurface.prototype._enableTracking.call(this);\n  };\n  Surface.prototype._trackMouse = function _trackMouse(e) {\n    if (this._suspendedTracking) {\n      return;\n    }\n    var shape = this.eventTarget(e);\n    if (e.type !== \"click\") {\n      var currentShape = this._currentShape;\n      if (currentShape && currentShape !== shape) {\n        this.trigger(\"mouseleave\", {\n          element: currentShape,\n          originalEvent: e,\n          type: \"mouseleave\"\n        });\n      }\n      if (shape && currentShape !== shape) {\n        this.trigger(\"mouseenter\", {\n          element: shape,\n          originalEvent: e,\n          type: \"mouseenter\"\n        });\n      }\n      this.trigger(\"mousemove\", {\n        element: shape,\n        originalEvent: e,\n        type: \"mousemove\"\n      });\n      this._currentShape = shape;\n    } else if (shape) {\n      this.trigger(\"click\", {\n        element: shape,\n        originalEvent: e,\n        type: \"click\"\n      });\n    }\n  };\n  Object.defineProperties(Surface.prototype, prototypeAccessors);\n  return Surface;\n}(BaseSurface);\nexport default Surface;","map":null,"metadata":{},"sourceType":"module"}